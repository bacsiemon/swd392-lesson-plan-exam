### COMPREHENSIVE AUTHENTICATION API TESTS
### Base URL
@baseUrl = http://localhost:5166/api

### Test Variables
@testEmail = testuser@example.com
@testPassword = Test123!
@teacherEmail = teacher@example.com
@teacherPassword = Teacher123!
@adminEmail = admin@example.com
@adminPassword = Admin123!

### Get access token from login response
@accessToken = {{loginTest.response.body.data.accessToken}}
@refreshToken = {{loginTest.response.body.data.refreshToken}}

###############################################
### 1. REGISTER TESTS
###############################################

### 1.1 Register Student Account
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}",
  "confirmPassword": "{{testPassword}}",
  "fullName": "Test Student User",
  "role": 2,
  "phoneNumber": "0123456789",
  "dateOfBirth": "1995-01-01T00:00:00.000Z"
}

### 1.2 Register Teacher Account
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "{{teacherEmail}}",
  "password": "{{teacherPassword}}",
  "confirmPassword": "{{teacherPassword}}",
  "fullName": "Test Teacher User",
  "role": 1,
  "phoneNumber": "0987654321",
  "dateOfBirth": "1985-05-15T00:00:00.000Z"
}

### 1.3 Register Admin Account
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "{{adminEmail}}",
  "password": "{{adminPassword}}",
  "confirmPassword": "{{adminPassword}}",
  "fullName": "Test Admin User",
  "role": 0,
  "phoneNumber": "0111222333"
}

### 1.4 Test Register - Duplicate Email (Should Fail)
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}",
  "confirmPassword": "{{testPassword}}",
  "fullName": "Duplicate User",
  "role": 2
}

### 1.5 Test Register - Invalid Email Format (Should Fail)
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "invalid-email",
  "password": "{{testPassword}}",
  "confirmPassword": "{{testPassword}}",
  "fullName": "Invalid Email User",
  "role": 1
}

### 1.6 Test Register - Weak Password (Should Fail)
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "weakpass@example.com",
  "password": "123",
  "confirmPassword": "123",
  "fullName": "Weak Password User",
  "role": 1
}

### 1.7 Test Register - Password Mismatch (Should Fail)
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "mismatch@example.com",
  "password": "{{testPassword}}",
  "confirmPassword": "DifferentPass123!",
  "fullName": "Mismatch User",
  "role": 1
}

###############################################
### 2. LOGIN TESTS
###############################################

### 2.1 Login with Student Account
# @name loginTest
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

### 2.2 Login with Teacher Account
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{teacherEmail}}",
  "password": "{{teacherPassword}}"
}

### 2.3 Login with Admin Account
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{adminEmail}}",
  "password": "{{adminPassword}}"
}

### 2.4 Test Login - Invalid Email (Should Fail)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "nonexistent@example.com",
  "password": "{{testPassword}}"
}

### 2.5 Test Login - Wrong Password (Should Fail)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "WrongPassword123!"
}

### 2.6 Test Login - Empty Email (Should Fail)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "",
  "password": "{{testPassword}}"
}

### 2.7 Test Login - Empty Password (Should Fail)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": ""
}

###############################################
### 3. PROTECTED ENDPOINTS TESTS (Need JWT)
###############################################

### 3.1 Get Current User Profile
GET {{baseUrl}}/account/profile
Authorization: Bearer {{accessToken}}

### 3.2 Test Profile Without Token (Should Fail 401)
GET {{baseUrl}}/account/profile

### 3.3 Test Profile With Invalid Token (Should Fail 401)
GET {{baseUrl}}/account/profile
Authorization: Bearer invalid_token_here

###############################################
### 4. PASSWORD MANAGEMENT TESTS
###############################################

### 4.1 Change Password (Valid)
POST {{baseUrl}}/account/change-password
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "currentPassword": "{{testPassword}}",
  "newPassword": "NewPassword123!",
  "confirmPassword": "NewPassword123!"
}

### 4.2 Test Change Password - Wrong Current Password (Should Fail)
POST {{baseUrl}}/account/change-password
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "currentPassword": "WrongCurrentPass123!",
  "newPassword": "NewPassword123!",
  "confirmPassword": "NewPassword123!"
}

### 4.3 Test Change Password - Password Mismatch (Should Fail)
POST {{baseUrl}}/account/change-password
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "currentPassword": "{{testPassword}}",
  "newPassword": "NewPassword123!",
  "confirmPassword": "DifferentPassword123!"
}

### 4.4 Test Change Password - Weak New Password (Should Fail)
POST {{baseUrl}}/account/change-password
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "currentPassword": "{{testPassword}}",
  "newPassword": "weak",
  "confirmPassword": "weak"
}

### 4.5 Change Password Without Token (Should Fail 401)
POST {{baseUrl}}/account/change-password
Content-Type: application/json

{
  "currentPassword": "{{testPassword}}",
  "newPassword": "NewPassword123!",
  "confirmPassword": "NewPassword123!"
}

###############################################
### 5. FORGOT PASSWORD TESTS
###############################################

### 5.1 Forgot Password - Valid Email
POST {{baseUrl}}/account/forgot-password
Content-Type: application/json

{
  "email": "{{testEmail}}"
}

### 5.2 Forgot Password - Non-existent Email (Should still return 200 for security)
POST {{baseUrl}}/account/forgot-password
Content-Type: application/json

{
  "email": "nonexistent@example.com"
}

### 5.3 Forgot Password - Invalid Email Format (Should Fail)
POST {{baseUrl}}/account/forgot-password
Content-Type: application/json

{
  "email": "invalid-email"
}

### 5.4 Forgot Password - Empty Email (Should Fail)
POST {{baseUrl}}/account/forgot-password
Content-Type: application/json

{
  "email": ""
}

###############################################
### 6. RESET PASSWORD TESTS
###############################################

### 6.1 Reset Password (Will fail - feature not fully implemented yet)
POST {{baseUrl}}/account/reset-password
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "resetToken": "SAMPLE_TOKEN",
  "newPassword": "ResetPassword123!",
  "confirmPassword": "ResetPassword123!"
}

### 6.2 Test Reset Password - Invalid Token Format (Should Fail)
POST {{baseUrl}}/account/reset-password
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "resetToken": "",
  "newPassword": "ResetPassword123!",
  "confirmPassword": "ResetPassword123!"
}

###############################################
### 7. REFRESH TOKEN TESTS
###############################################

### 7.1 Refresh Token (Will fail - feature not fully implemented yet)
POST {{baseUrl}}/account/refresh-token
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

### 7.2 Test Refresh Token - Invalid Token (Should Fail)
POST {{baseUrl}}/account/refresh-token
Content-Type: application/json

{
  "refreshToken": "invalid_refresh_token"
}

### 7.3 Test Refresh Token - Empty Token (Should Fail)
POST {{baseUrl}}/account/refresh-token
Content-Type: application/json

{
  "refreshToken": ""
}

###############################################
### 8. LOGOUT TESTS
###############################################

### 8.1 Logout (Valid)
POST {{baseUrl}}/account/logout
Authorization: Bearer {{accessToken}}

### 8.2 Logout Without Token (Should Fail 401)
POST {{baseUrl}}/account/logout

### 8.3 Logout With Invalid Token (Should Fail 401)
POST {{baseUrl}}/account/logout
Authorization: Bearer invalid_token

###############################################
### 9. ADMIN ENDPOINTS TESTS
###############################################

### 9.1 Get All Accounts (Admin only) - Use admin token
GET {{baseUrl}}/account?page=1&size=10
Authorization: Bearer {{accessToken}}

### 9.2 Get All Accounts Without Token (Should Fail 401)
GET {{baseUrl}}/account?page=1&size=10

### 9.3 Test Pagination
GET {{baseUrl}}/account?page=2&size=5
Authorization: Bearer {{accessToken}}

###############################################
### 10. EDGE CASES AND SECURITY TESTS
###############################################

### 10.1 Test SQL Injection in Email
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "test@example.com'; DROP TABLE accounts; --",
  "password": "{{testPassword}}"
}

### 10.2 Test XSS in Full Name (Register)
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "xsstest@example.com",
  "password": "{{testPassword}}",
  "confirmPassword": "{{testPassword}}",
  "fullName": "<script>alert('XSS')</script>",
  "role": 2
}

### 10.3 Test Very Long Email
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "verylongemailaddressthatexceedsnormallimitsandmightcauseissues@verylongdomainnamethatisunusuallylong.com",
  "password": "{{testPassword}}",
  "confirmPassword": "{{testPassword}}",
  "fullName": "Long Email User",
  "role": 2
}

### 10.4 Test Special Characters in Password
POST {{baseUrl}}/account/register
Content-Type: application/json

{
  "email": "specialchars@example.com",
  "password": "Sp3c!@l#$%^&*()_+{}|:<>?[]\\;'\",.`~",
  "confirmPassword": "Sp3c!@l#$%^&*()_+{}|:<>?[]\\;'\",.`~",
  "fullName": "Special Chars User",
  "role": 2
}

###############################################
### 11. LOGIN WITH NEW PASSWORD (After Change)
###############################################

### 11.1 Try Login with Old Password (Should Fail after password change)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

### 11.2 Login with New Password (Should Work after password change)
POST {{baseUrl}}/account/login
Content-Type: application/json

{
  "email": "{{testEmail}}",
  "password": "NewPassword123!"
}

###############################################
### SUMMARY OF EXPECTED RESULTS:
###############################################
# ✅ Should PASS:
# - Valid registrations
# - Valid logins  
# - Profile access with valid token
# - Password change with correct current password
# - Forgot password requests
# - Logout with valid token

# ❌ Should FAIL:
# - Duplicate email registration
# - Invalid email formats
# - Weak passwords
# - Password mismatches
# - Invalid login credentials
# - Protected endpoints without token
# - Password change with wrong current password
# - Reset password (not implemented)
# - Refresh token (not implemented)
# - Admin endpoints with non-admin token

# ⚠️ PARTIALLY IMPLEMENTED:
# - Reset password (returns 501)
# - Refresh token (returns 501)
# - Email sending (may fail if not configured)